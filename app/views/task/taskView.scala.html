@(project:Project)

@main("TaskManager", project){
    
  <h1>TaskManager</h1>
  <style>
  section.line {
    width : 150px;
    float : left;
    border : 2px solid #666666;
    background : #fafafa;
    margin-right : 5px;
    border-radius : 5px;
    text-align : center;
    cursor : move;
  }
  section.line header {
    padding : 5px;
    background-color : #dadada;
    border-top-left-radius : 5px;
    border-top-right-radius : 5px;
  }
  article.card {
    background : #b9a;
    margin : 4px;
    border-radius : 3px;
    border : 1px solid gray;
    min-height : 20px;
  }
  .cardlist {
    border: 2px solid #f1f1f1;
    background: #f1f1f1;
  }
  .over {
    border: 2px dashed #000;
  }
  
  .dragTargetCard{
    background-color: dadada;
    color: dadada;
  }
  .blank{
    min-height: 3px;
  }
  .overBlank{
    min-height: 25px;
    background-color: #ddd;
  }
  .fade{
    background : #333;
  }
  </style>
  <div ng-controller="controller">
    <section ng-repeat="line in lines" class="line">
      <header>{{line.title}}</header>
      <div class="cardlist" id="cardlist_{{line._id}}" >
        <article class="blank"></article>
        <div ng-repeat="card in line.cards" > 
          <article class="card" draggable="true" ui-event="{'dragstart': 'onDragStart(line, card)'}" >
            {{card.title}}
          </article>
          <article class="blank"></article>
        </div>
      </div>
      <article>
        <form ng-submit="addCard(line)">
          <input type="submit" value="add"/>
        </form>
      </article>
    </section>
  </div>
  <script>
  $(function(){
    var myapp = angular.module('myapp', ['ui']);
    var TaskCtrl = function($scope){
        var dragStart = {};
        
        var webSocket = new WebSocket("ws://" +location.host + location.pathname + "/connect");
        webSocket.onmessage = function(e){
          $scope.lines = JSON.parse(e.data);
          $scope.$apply();
        }
        webSocket.onopen = function(){
          console.log("socket Open!");
        }
        webSocket.onclose = function(){
          console.log("disconnected!");
          console.log("trying to reconnect...");
          console.log("unimplement");
        }
        $scope.addCard = function(line){
            console.log("added!");
            console.log(line);
            line.cards.push("adding card");
            return false;
        }
        $scope.onDragOver = function($event) {
            $event.preventDefault();
        };
        $scope.onDragleave = function($event) {
            $event.preventDefault();
        };
        $scope.onDrop = function($event, targetLine) {
          if (dragStart === null ) return;
          if( targetLine._id !== dragStart.line._id){
            if (dragStart !== null ) {
              targetLine.cards.push(dragStart.card);
              dragStart.line.cards = _.without(dragStart.line.cards, dragStart.card);
            }
          }
          webSocket.send(JSON.stringify($scope.lines));
        };
        $scope.onDragStart = function(currentLine, currentCard) {
            dragStart = {
              line: currentLine, 
              card: currentCard,
              idx: _.indexOf(currentLine.cards, currentCard)
            };
        };

        $scope.onDragOverBlank = function($event) {
          $event.preventDefault();
        };
        $scope.onDragleaveBlank = function($event) {
          $event.preventDefault();
        };
        $scope.onDropBlank = function($event, targetLine, targetCard) {
          if (dragStart === null ) return;
          var prvIdx = null;
          if( targetLine._id == dragStart.line._id){
            targetLine.cards.splice(dragStart.idx, 1);
          } else {
            dragStart.line.cards = _.without(dragStart.line.cards, dragStart.card);
          }
          targetLine.cards.splice(_.indexOf(targetLine.cards, targetCard)+1, 0, dragStart.card);
          dragStart = null;
          webSocket.send(JSON.stringify($scope.lines));
          console.log("currentLine:", targetLine);
        };
    };
    myapp.controller('controller', TaskCtrl);
    angular.bootstrap(document, ['myapp']);
  });
  (function(){
    $(".cardlist").live("drop", function(e){
      if (e.stopPropagation) e.stopPropagation();
      e.preventDefault();
    });

    $(".cardlist")
      .live("dragover", function(e){
        $(this).addClass("over");
        return e.preventDefault();
      })
      .live("drop dragleave", function(e){
        $(this).removeClass("over");
      });
    $(".card").live("dragstart", function(e){
    });

    $(".blank")
      .live("dragover", function(e){
        $(this).addClass("overBlank");
        return e.preventDefault();
      })
      .live("drop dragleave", function(e){
        $(this).removeClass("overBlank");
      });
    $(".cardlist").attr("ui-event", "{dragover: 'onDragOver($event)', dragleave: 'onDragLeave($event)', drop: 'onDrop($event, line)'}");
    $(".blank").attr("ui-event", "{dragover: 'onDragOverBlank($event)', dragleave: 'onDragLeaveBlank($event)', drop: 'onDropBlank($event, line, card)'}");
  })();
  </script>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>
  <script type="text/javascript" src="http://underscorejs.org/underscore.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>
  <script type="text/javascript" src="https://raw.github.com/angular-ui/angular-ui/master/build/angular-ui.min.js"></script>
}
