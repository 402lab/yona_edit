<!-- 실제로 이것들은 미리 로딩되어 있음 -->
<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>
<script type="text/javascript" src="http://underscorejs.org/underscore.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>
<script type="text/javascript" src="https://raw.github.com/angular-ui/angular-ui/master/build/angular-ui.min.js"></script>
<!-- preloading section end -->
<style>
input.card_title {
  border: 0px;
}

ul {
  list-style: none;
  padding: 0px;
}
</style>
<div ng-controller="CardCtrl">
  <section class="card">
    <!--
      //클릭하지 않았을때는 그냥 잘 보여주다 클릭하면 input으로 바꾸기.
      //         (아마 onclick에서 바꾸고 onBlur에서 다시 원상 복귀하면 될듯.)-->
    <input type="text" ng-model="card.title" class="card_title" /> <input ng-model="card.storyPoint"
      ui-event="{'blur':'saveCard()'}" type="number" min="0" max="500" /><br />
    <textarea ng-model="card.body"></textarea>
    <button ng-click="saveCard()">save</button>
    <div>
      <fieldset>
        <legend>assignee</legend>
        <div ng-repeat="member in card.assignee">
          <span>{{member.loginId}}</span>
        </div>
        <button ng-click="showMemberList()">assign</button>
        <div ng-show="input.assign" ng-repeat="member in board.members">
          <span><input type="checkbox" ng-model="member.assigned" ng-change="assign(member)" />{{member.loginId}}</span>
        </div>
      </fieldset>
    </div>
    <div ng-repeat="label in board.labels">
      <span><input type="checkbox" ng-model="label.state" ng-change="saveCard()" />{{label.name}}</span>
      <!-- 색깔라벨 나오게 만들것! -->
    </div>
    <div>
      DueDate : <input type="date" ng-model="card.dueDate" ui-event="{'blur':'saveCard()'}" />
    </div>
    <button ng-hide="card.checklist" ng-click="makeCheckList()">makeCheckList</button>
    <fieldset ng-show="card.checklist">
      <legend>{{card.checklist.title}}</legend>
      <ul ng-repeat="item in card.checklist.items">
        <li><input type="checkbox" ng-model="item.state" ng-click="checkItem(item)" /> {{item.body}}</li>
      </ul>
      <input type="text" ng-model="input.checklist" />
      <button ng-click="addChecklist()">add</button>
    </fieldset>
  </section>
  <section id="taskComments" ng-repeat="comment in card.comments">
    <article>{{comment.body}}</article>
  </section>
  <div>
    <form ng-submit="addComment()">
      <textarea id="comment_input" ng-model="input.comment"></textarea>
      <input type="submit" value="comment" />
    </form>
  </div>
</div>
<script>
  //웹소켓은 그야말로 클라 노티에만 쓰고 노티오면 다시 리로딩.
  //taskBoard는 완전히 따로 생각한다. 리로딩시 문제는 없음.
  var cardLoad;
  $(function() {
    //angular!
    var cardapp = angular.module('cardApp', [ 'ui' ]);
    function CardCtrl($scope) {
      $scope.card; //model
      $scope.board = {};
      $scope.input = {
        comment : ""
      };
      cardLoad = function(id) {
        $.ajax("c/" + id, {
          dataType : "json",
          success : function(data) {
            $scope.card = data;
            $scope.$apply();
            adjust();
          }
        });
      }
      $.ajax("member", {
        success : function(data) {
          $scope.board.members = data;
          adjust();
        }
      });
      function adjust() {
        if ($scope.card && $scope.board && $scope.board.members) {
          var assignee = $scope.card.assignee;
          var members = $scope.board.members;
          for ( var i = 0; i < members.length; i++) {
            members[i].assigned = false;
            for ( var j = 0; j < assignee.length; j++) {
              if (members[i]._id == assignee[j]._id) {
                members[i].assigned = true;
                assignee[j] = members[i];
              }
            }
          }
          $scope.$apply();
        }
        if ($scope.card && $scope.board && $scope.board.labels) {
          var cardLabels = $scope.card.labels;
          var boardLabels = $scope.board.labels;
          for ( var i = 0; i < boardLabels.length; i++) {
            boardLabels[i].state = false;
            for ( var j = 0; j < cardLabels.length; j++) {
              if (cardLabels[j]._id == boardLabels[i]._id) {
                boardLabels[i].state = true;
              }
            }
          }
        }
        $scope.$apply()
      }
      $.ajax("labels", {
        success : function(data) {
          $scope.board.labels = data;
          adjust();
        },
        dataType : "json"
      });
      //inti function end 
      $scope.addComment = function() {
        $scope.card.comments.push($scope.input.comment);
        server.addComment($scope.card._id, $scope.input.comment);
        $scope.input.comment = "";

      }
      $scope.saveCard = function() {
        $scope.card.labels = [];
        for ( var i = 0; i < $scope.board.labels.length; i++) {
          if ($scope.board.labels[i].state == true) {
            $scope.card.labels.push($scope.board.labels[i]);
          }
        }
        server.saveCard($scope.card);
        console.log($scope.card);
      }
      $scope.showMemberList = function() {
        $scope.input.assign = !$scope.input.assign;
      }
      $scope.makeCheckList = function(){
        $scope.card.checklist = {
          items : [],
          title : "TODO"
        };
      }
      $scope.addChecklist = function() {
        $scope.card.checklist.items.push({
          body : $scope.input.checklist,
          state : false
        });
        $scope.input.checklist = "";
        $scope.saveCard();
      }
      $scope.checkItem = function(item) {
        $scope.saveCard();
      }
      $scope.assign = function(member) {
        if (member.assigned) {
          $scope.card.assignee.push(member);
        } else {
          $scope.card.assignee = _.without($scope.card.assignee, member);
        }
        $scope.saveCard();
      }
      cardLoad(1);// for TEST
    }
    cardapp.controller('CardCtrl', CardCtrl);//여기는 실제함수와 어트리뷰트간의 관계맺기
    angular.bootstrap(document, [ 'cardApp' ]);

    var server = {};
    server.addComment = function(_id, str) {
      $.ajax("comment", {
        type : "POST",
        data : {
          body : str,
          _id : _id
        },
        success : function(data) {
          cardLoad(_id);
        }
      });
    };
    server.saveCard = function(card, callback) {
      //서버로 카드 전체를 보내서 저장합니다.
      $.ajax("card", {
        type : "post",
        data : JSON.stringify(card),
        contentType : "text/json",
        success : function(data) {
          if (callback)
            callback();
        }
      });
    }
  });
</script>
