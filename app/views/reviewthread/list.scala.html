@**
 * Yobi, Project Hosting SW
 *
 * Copyright 2014 NAVER Corp.
 * http://yobi.io
 *
 * @Author Keesun Baik
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **@
@(project:Project, page:com.avaje.ebean.Page[CommentThread], param:models.support.ReviewSearchCondition)
@import views.html.helper.form
@import utils.TemplateHelper._
@import utils.JodaDateUtil

@buildPath(state:String, sortField:String, orderDir:String, authorId:Long) = @{
    var path = "?state=" + state + "&orderBy=" + sortField + "&orderDir=" + orderDir
    if (authorId != null) {
        path = path + "&authorId=" + authorId
    }
    path
}
@makeSortLink(sortField:String, sortFieldString:String) = {
    @if(param.orderBy == sortField) {
        @if(param.orderDir == "asc") {
            <a href="@routes.ReviewThreadApp.reviewThreads(project.owner, project.name)@buildPath(param.state, sortField, "desc", param.authorId)" class="filter">
                <i class="ico btn-gray-arrow"></i>@sortFieldString
            </a>
        } else {
            <a href="@routes.ReviewThreadApp.reviewThreads(project.owner, project.name)@buildPath(param.state, sortField, "asc", param.authorId)" class="filter">
                <i class="ico btn-gray-arrow down"></i>@sortFieldString
            </a>
        }
    } else {
        <a href="@routes.ReviewThreadApp.reviewThreads(project.owner, project.name)@buildPath(param.state, sortField, "desc", param.authorId)" class="filter">
            <i class="ico btn-gray-arrow down"></i>@sortFieldString
        </a>
    }
}

@paramForEveryone = { @CommentThread.countReviewsBy(project.id, param.clone.setAuthorId(null).setParticipationId(null)) }
@paramForParticipant = { @CommentThread.countReviewsBy(project.id, param.clone.setAuthorId(null).setParticipationId(UserApp.currentUser().id)) }
@paramForAuthor = { @CommentThread.countReviewsBy(project.id, param.clone.setParticipationId(null).setAuthorId(UserApp.currentUser().id)) }

@projectLayout(Messages("menu.review"), project, utils.MenuType.PROJECT_REVIEW) {
    @projectMenu(project, utils.MenuType.PROJECT_REVIEW, "")

<div class="project-page-wrap">
    <div class="row-fluid issue-list-wrap">
        <div class="span2 search-wrap">
            <div class="inner advanced">
                <ul class="lst-stacked unstyled">
                    <li @if(param.participationId == null && param.authorId == null){class="active"}>
                        <a href="@routes.ReviewThreadApp.reviewThreads(project.owner, project.name)">
                            @Messages("review.allReview")
                            <span class="num-badge pull-right">@paramForEveryone</span>
                        </a>
                    </li>
                    <li @if(param.participationId == UserApp.currentUser().id){class="active"}>
                        <a href="@routes.ReviewThreadApp.reviewThreads(project.owner, project.name)?participationId=@UserApp.currentUser().id">
                            @Messages("review.involvingYou")
                            <span class="num-badge pull-right">@paramForParticipant</span>
                        </a>
                    </li>
                    <li @if(param.authorId == UserApp.currentUser().id){class="active"}>
                        <a href="@routes.ReviewThreadApp.reviewThreads(project.owner, project.name)?authorId=@UserApp.currentUser().id">
                            @Messages("review.createdByYou")
                            <span class="num-badge pull-right">@paramForAuthor</span>
                        </a>
                    </li>
                </ul>
                @form(routes.ReviewThreadApp.reviewThreads(project.owner, project.name)) {
                    <input type="hidden" name="authorId" value="@param.authorId">
                    <input type="hidden" name="participationId" value="@param.participationId">
                    <input type="hidden" name="orderDir" value="@param.orderDir">
                    <input type="hidden" name="orderBy" value="@param.orderBy">
                    <input type="hidden" name="state" value="@param.state">
                    <hr>
                    <div class="srch-input">
                        <div class="srch-input-inner">
                            <input type="text" name="filter" class="text" value="">
                            <button type="submit" class="btn-transparent"><i class="yobicon-search"></i></button>
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="span10">
            <div class="pull-right filters">
                @makeSortLink("createdDate", Messages("common.order.date"))
            </div>
            <ul class="nav nav-tabs nm">
                @for(state <- Array(State.OPEN, State.CLOSED)) {
                <li  @if(param.state == state.name) { class="active"}>
                    <a href="@routes.ReviewThreadApp.reviewThreads(project.owner, project.name)?pageNum=1&state=@state.name&authorId=@param.authorId&participationId=@param.participationId">
                        @Messages("issue.state." + state.name.toLowerCase())
                        <span class="num-badge">@CommentThread.countReviewsBy(project.id, param.clone.setState(state.name))</span>
                    </a>
                </li>
               }
            </ul>
            <div class="review-list-wrap">
                @if(page.getList().size() > 0){
                <ul>
                    @for(thread <- page.getList())  {
                        @defining(User.find.byId(thread.getFirstReviewComment.author.id)){ user =>
                        <li class="review-item">
                            <div class="review-number">
                                <a href="@DiffRenderer.urlToCommentThread(project, thread)">#@thread.id</a>
                            </div>
                            <div class="review-avatar">
                                @if(user != null){
                                <a href="@routes.UserApp.userInfo(user.loginId)" class="avatar-wrap mlarge">
                                    <img src="@user.avatarUrl" alt="@@thread.getFirstReviewComment.author.authorName">
                                </a>
                                } else {
                                <div class="avatar-wrap mlarge">
                                    <img src="@routes.Assets.at("images/default-avatar-64.png")" width="42" height="42">
                                </div>
                                }
                            </div>
                            <div class="review-content">
                                <div class="review-comment">
                                    <a href="@DiffRenderer.urlToCommentThread(project, thread)">
                                        @thread.getFirstReviewComment.getContents()
                                    </a>
                                </div>
                                <div class="review-meta">
                                    <span class="author">
                                        <a href="@routes.UserApp.userInfo(user.loginId)" class="author">
                                            @user.name
                                        </a>
                                    </span>
                                    <span class="date">
                                        @agoString(JodaDateUtil.ago(thread.createdDate))
                                    </span>
                                    <span>
                                        <i class="yobicon-comment"></i> @defining(thread.reviewComments.size()-1) { numberOfComments => @numberOfComments }
                                    </span>
                                </div>
                            </div>
                        </li>
                        }
                    }
                </ul>
                } else {
                <div class="error-wrap">
                    <i class="ico ico-err1"></i>
                    <p>@Messages("review.is.empty")</p>
                </div>
                }
            </div>
            <div id="pagination"></div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        $yobi.loadModule("review.List", {
            "elPagination": $("#pagination"),
            "nTotalPages" : @page.getTotalPageCount()
        });
    });
</script>
}
