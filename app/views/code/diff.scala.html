@(project: Project, commit:playRepository.Commit,
parentCommit:playRepository.Commit, threads:List[CodeCommentThread], selectedBranch:String, diff:
List[playRepository.FileDiff],path:String)

@import playRepository.RepositoryService
@import java.net.URLEncoder
@import utils.TemplateHelper._
@import utils.TemplateHelper.Branches._
@import utils.JodaDateUtil
@import utils.AccessControl._

@projectLayout(Messages("code.commits") + " @" + commit.getId, project, utils.MenuType.CODE) {
@projectMenu(project, utils.MenuType.CODE, "main-menu-only")

<div class="page-wrap-outer">
    <div class="project-page-wrap">
        <div id="code-browse-wrap" class="code-browse-wrap">
            <div id="branches" class="btn-group branches pull-right" data-name="branch" data-activate="manual">
                <button class="btn dropdown-toggle large" data-toggle="dropdown">
                    <span class="d-label">@selectedBranch</span>
                    <span class="d-caret"><span class="caret"></span></span>
                </button>
                <ul class="dropdown-menu">
                @defining(RepositoryService.getRepository(project).getBranches()) { branches =>
                    @for(branch <- branches){
                        @common.branchItem("history", project, branch, null,
                            utils.TemplateHelper.equals(branch, selectedBranch))
                    }
                }
                </ul>
            </div>

            <ul class="nav nav-tabs" style="margin-bottom:20px;">
                <li>
                    <a href="@routes.CodeApp.codeBrowser(project.owner, project.name)">@Messages("code.files")</a>
                </li>
                <li class="active">
                    <a href="@routes.CodeHistoryApp.historyUntilHead(project.owner, project.name)">@Messages("code.commits")</a>
                </li>
            </ul>

            <p class="commitInfo">
                @(commit.getAuthor, commit.getAuthorEmail, commit.getAuthorName) match {
                case (user: User, _, _) if !user.isAnonymous => {
                    <a href="@routes.UserApp.userInfo(commit.getAuthor.loginId)" class="avatar-wrap">
                        <img src="@commit.getAuthor.avatarUrl" alt="@commit.getAuthor.name" width="32" height="32"/>
                    </a>
                    <strong>@commit.getAuthor.name</strong>
                }
                case (_, email, name) if email != null => {
                    <span class="avatar-wrap">
                        <img src="@urlToPicture(commit.getAuthorEmail, 32)" width="32" height="32">
                    </span>
                    @if(name != null) {
                    <strong>@name</strong>
                    }
                }
                case (_, _, name) if name != null => {
                    <strong>@name</strong>
                }
                case (_, _, _) => {
                    <strong>@User.anonymous.name</strong>
                }
                }
                <span class="ago" title="@JodaDateUtil.getDateString(commit.getAuthorDate)">
                    @agoString(JodaDateUtil.ago(commit.getAuthorDate))
                </span>
                <strong class="commitId pull-right">@{"@"}@commit.getId</strong>
                @if(threads.size > 0) {
                <span class="pull-right mt5 mr10">
                    <input id="toggle-comments" type="checkbox" checked="checked" class="checkbox">
                    <label for="toggle-comments" class="form-label">@Messages("code.showcomments")</label>
                </span>
                }
            </p>
            <pre class="commitMsg">@commit.getMessage</pre>
            <div class="diff-body">
                @views.html.partial_diff(diff, threads, project, project)
                <div class="btnPop"><button type="button" class="ybtn ybtn-info ybtn-mini"><i class="yobicon-comments"></i></button></div>
            </div>

            @** Comment **@
            <div id="comments-wrap" class="board-comment-wrap">
                @defining(threads.filter(v => v.codeRange == null)) { threads =>
                @if(threads.size > 0) {
                <ul class="comments">
                    @for(thread <- threads){
                    @for(comment <- thread.reviewComments){
                    <li id="comment-@comment.id" data-thread-id="@thread.id" class="comment">
                        <div class="comment-avatar">
                            <a href="@routes.UserApp.userInfo(comment.author.loginId)"
                               class="avatar-wrap" data-toggle="tooltip" data-placement="top"
                               title="@comment.author.name">
                                <img src="@User.findByLoginId(comment.author.loginId).avatarUrl"
                                     width="32" height="32" alt="@comment.author.loginId">
                            </a>
                        </div>
                        <div class="media-body">
                            <div class="meta-info">
                                <span class="comment_author pull-left">
                                    <i class="yobicon-comment"></i>
                                    <a href="@routes.UserApp.userInfo(comment.author.loginId)" data-toggle="tooltip" data-placement="top" title="@comment.author.name">
                                        <strong>@comment.author.loginId </strong>
                                    </a>
                                </span>
                                <span class="ago" title="@JodaDateUtil.getDateString(comment.createdDate)">
                                    <a href="#comment-@comment.id">
                                        @agoString(JodaDateUtil.ago(comment.createdDate))
                                    </a>
                                </span>
                                @if(isAllowed(UserApp.currentUser(), comment.asResource(), Operation.DELETE)){
                                <span class="edit pull-right">
                                    <button class="btn-transparent pull-right close" data-toggle="comment-delete" data-request-uri="@routes.CodeHistoryApp.deleteComment(project.owner, project.name, commit.getId, comment.id)" title="@Messages("common.comment.delete")"><i class="yobicon-trash"></i></button>
                                </span>
                                }
                            </div>

                            <div class="comment-body markdown-wrap markdown-before" markdown="true">@comment.getContents</div>

                            <div class="attachments" data-resourceType="@ResourceType.COMMIT_COMMENT" data-resourceId="@comment.id"></div>
                        </div>
                    </li>
                    }
                    }
                </ul>
                }
                }

                @common.commentForm(project, ResourceType.COMMIT_COMMENT, routes.CodeHistoryApp.newComment(project.owner, project.name, commit.getId).toString())
            </div>
            @** // Comment **@

            @** BlockComment **@
            @if(isProjectResourceCreatable(UserApp.currentUser, project, ResourceType.COMMIT_COMMENT)){
                @common.reviewForm(project, ResourceType.COMMIT_COMMENT, routes.CodeHistoryApp.newComment(project.owner, project.name, commit.getId).toString())
            }
            @** // BlockComment **@
        </div>

        <button id="watch-button" type="button" class="pull-left ybtn @if(commit.getWatchers(project).contains(UserApp.currentUser())) { active ybtn-watching }" data-toggle="button">@Messages("notification.watch")</button>

        <a href="@routes.CodeHistoryApp.history(project.owner, project.name, selectedBranch, path)" class="ybtn pull-right">@Messages("button.list")</a>

        <div id="minimap" class="minimap-outer">
            <div class="minimap-wrap">
                <div class="minimap-curr"></div>
                <div class="minimap-links"></div>
            </div>
        </div>
    </div>
</div>
@common.markdown(project)
@common.mergely()
@common.commentDeleteModal("#code-browse-wrap")

<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("javascripts/lib/mentionjs/mention.css")">
<script type="text/javascript" src="@routes.Assets.at("javascripts/lib/mentionjs/mention.js")"></script>
<script type="text/javascript" src="@routes.Assets.at("javascripts/common/yobi.CodeCommentBlock.js")"></script>
<script type="text/javascript" src="@routes.Assets.at("javascripts/common/yobi.CodeCommentBox.js")"></script>
<script type="text/javascript">
    $(document).ready(function(){
        $yobi.loadModule("code.Diff", {
            "welDiff"     : $("#commit"),
            "bCommentable": @if(isProjectResourceCreatable(UserApp.currentUser, project, ResourceType.COMMIT_COMMENT)){true}else{false},
            "sWatchUrl"   : "@routes.WatchApp.watch(commit.asResource(project).asParameter)",
            "sUnwatchUrl" : "@routes.WatchApp.unwatch(commit.asResource(project).asParameter)"
        });

        yobi.Mention({
            target:'comment-editor',
            url : "@Html(routes.ProjectApp.mentionListAtCommitDiff(project.owner, project.name, commit.getId).toString)"
        });
    });
</script>
}
