@(project: Project, pull: PullRequest, comments: List[PullRequestComment])

@import utils.JodaDateUtil._
@import utils.TemplateHelper._
@import utils.AccessControl._
@import models.enumeration
@import scala.collection.JavaConversions._

@branchName(branch:String) = @{
    branch.replace("refs/heads/", "")
}

@getCodeURL(project: Project) = @{
    if(session == null){
        CodeApp.getURL(project.owner, project.name)
    } else {
        defining(ProjectUser.roleOf(session.get("loginId"), project)) { role =>
            if(role == "manager" || role == "member"){
                CodeApp.getURL(project.owner, project.name).replace("://", "://" + session.get("loginId") + "@")
            } else {
                CodeApp.getURL(project.owner, project.name)
            }
        }
    }
}

@conflictMessage = {
    <div class="alert alert-error">
        <h5>@Messages("pullRequest.is.not.safe")</h5>
        <div>
            <h5>@Messages("pullRequest.conflict.files")</h5>
            <ul class="unstyled conflict-files">
                @for(file <- pull.getConflictFiles) {
                <li><i class="yobicon-file"></i> @file</li>
                }
            </ul>
        </div>
        <div>
            <h5>@Messages("pullRequest.resolve.conflict")</h5>
            <ol>
                <li>@Messages("pullRequest.resolver.step1") <code>git checkout @branchName(pull.fromBranch)</code></li>
                <li>@Messages("pullRequest.resolver.step2") <code>git remote add upstream @getCodeURL(pull.toProject)</code></li>
                <li>@Messages("pullRequest.resolver.step3") <code>git fetch upstream</code></li>
                <li>@Messages("pullRequest.resolver.step4") <code>git rebase upstream/@branchName(pull.toBranch)</code></li>
                <li>@Messages("pullRequest.resolver.step5") </li>
                <li>@Messages("pullRequest.resolver.step6") <code>git add 충돌을_해결한_파일</code></li>
                <li>@Messages("pullRequest.resolver.step7") <code>git rebase --continue</code></li>
                <li>@Messages("pullRequest.resolver.step8") </li>
                <li>@Messages("pullRequest.resolver.step9") <code>git push -f origin @branchName(pull.fromBranch)</code></li>
                <li>@Messages("pullRequest.resolver.step10") <a href="@routes.PullRequestApp.pullRequest(project.owner, project.name, pull.number)" class="ybtn ybtn-info ybtn-small">@Messages("button.page.refresh")</a>@Messages("pullRequest.resolver.step11")</li>
            </ol>
        </div>
    </div>
}

@projectLayout(Messages("menu.pullRequest"), project, utils.MenuType.PULL_REQUEST) {
    <div class="page">
        @projectMenu(project, utils.MenuType.PULL_REQUEST, "main-menu-only")

        <div class="pullreq-info">
            <div class="pull-right">
                <button id="helpBtn" class="ybtn ybtn-inverse ybtn-mini mt5">
                    <i class="yobicon-question-sign yobicon-large"></i> @Messages("title.help")
                </button>
            </div>
            <div>
                <a href="@routes.UserApp.userInfo(pull.contributor.loginId)" class="avatar-wrap">
                    <img src="@pull.contributor.avatarUrl" width="32" height="32">
                </a>
                <a href="@routes.UserApp.userInfo(pull.contributor.loginId)">
                    <strong>@pull.contributor.name (@pull.contributor.loginId)</strong>
                </a>
                @Messages("pullRequest.merge.requested")

                <div class="pullRequest-branch ml10">
                    <span data-toggle="tooltip" data-original-title="@Messages("pullRequest.from")">
                        <code class="from">
                            <i class="yobicon-branch"></i>
                            <a href="@routes.UserApp.userInfo(pull.fromProject.owner)">@pull.fromProject.owner</a>/<!--
                         --><a href="@routes.ProjectApp.project(pull.fromProject.owner, pull.fromProject.name)">@pull.fromProject.name</a>:
                            @branchName(pull.fromBranch)
                        </code>
                    </span>
                    <i class="yobicon-right ml10"></i>
                    <span class="ml10" data-toggle="tooltip" data-original-title="@Messages("pullRequest.to")">
                        <code class="to">
                            <i class="yobicon-branch"></i>
                            <a href="@routes.UserApp.userInfo(pull.toProject.owner)">@pull.toProject.owner</a>/<!--
                         --><a href="@routes.ProjectApp.project(pull.toProject.owner, pull.toProject.name)">@pull.toProject.name</a>:
                            @branchName(pull.toBranch)
                        </code>
                    </span>
                </div>
            </div>
            <div id="helpMessage" class="well" style="display:none;">
                <div class="row-fluid">
                <div class="pull-left">
                    <img class="img-polaroid" src="@routes.Assets.at("images/fork-pull/merge.jpg")"><br>
                </div>
                <div class="pull-left help-messages">
                    <p class="lead">@Messages("pullRequest.merge.help.1")</p>
                    <p>@Messages("pullRequest.merge.help.2")</p>
                    <p>@Messages("pullRequest.merge.help.3")</p>
                    <p>@Messages("pullRequest.merge.help.4")</p>
                </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs nm">
            <li><a href="@routes.PullRequestApp.pullRequest(project.owner, project.name, pull.number)">@Messages("pullRequest.menu.overview")</a></li>
            <li><a href="@routes.PullRequestApp.pullRequestCommits(project.owner, project.name, pull.number)">@Messages("pullRequest.menu.commit")</a></li>
            <li class="active"><a href="@routes.PullRequestApp.pullRequestChanges(project.owner, project.name, pull.number)">@Messages("pullRequest.menu.changes")</a></li>
        </ul>

        <div id="__changes">
            <div class="diff-body">
                @if(pull.isMerging) {
                  <div class="alert alert-warnning">
                    <h5>@Messages("pullRequest.is.merging")</h5>
                  </div>
                } else {
                  @if(pull.isConflict) {
                    @conflictMessage
                  } else {
                    @views.html.partial_diff(pull.getDiff, comments.filter(v => !v.isOutdated))
                  }
                }
            </div>
            <div id="compare" class="modal hide compare-wrap" tabindex="-1" role="dialog">
                <h4 class="path">
                    <span></span>
                    <button type="button" class="ybtn pull-right" data-dismiss="modal" style="margin-right:20px;">@Messages("button.confirm")</button>
                </h4>
                <div class="row-fluid">
                    <div class="span6 compare-from"></div>
                    <div class="span6 compare-to"></div>
                </div>
                <div id="mergely" class="mergely-wrap"></div>
            </div>
        </div>
    </div>

@common.markdown(project)

<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("javascripts/lib/mergely/codemirror.css")">
<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("javascripts/lib/mergely/mergely.css")">
<link rel="stylesheet" type="text/css" media="screen" href="@getCSSLink("mention")">
<script type="text/javascript" src="@getJSLink("lib/mentionjs/mention")"></script>
<script type="text/javascript" src="@getJSLink("lib/diff")"></script>
<script type="text/javascript" src="@getJSLink("lib/mergely/codemirror.min")"></script>
<script type="text/javascript" src="@getJSLink("lib/mergely/mergely")"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $yobi.loadModule("git.View", {
            "sWatchUrl"  : "@routes.WatchApp.watch(pull.asResource.asParameter)",
            "sUnwatchUrl": "@routes.WatchApp.unwatch(pull.asResource.asParameter)"
        });

        yobi.Mention({
            target:'comment-editor',
            @if(pull.getCurrentCommits.isEmpty()) {
                url : "@Html(routes.ProjectApp.mentionListAtPullRequest(pull.toProject.owner, pull.toProject.name, "", pull.id).toString)"
            } else {
                url : "@Html(routes.ProjectApp.mentionListAtPullRequest(pull.toProject.owner, pull.toProject.name, pull.getCurrentCommits.get(0).getCommitId, pull.id).toString)"
            }
        });

        $yobi.loadModule("code.Diff", {
            "welDiff"      : $("#pull-request-changes"),
            "bCommentable" : "@isProjectResourceCreatable(UserApp.currentUser, project, ResourceType.PULL_REQUEST_COMMENT)",
            "sTplFileURLA" : "@routes.CodeApp.codeBrowserWithBranch(pull.toProject.owner, pull.toProject.name, "${commitId}", "${path}")",
            "sTplFileURLB" : "@routes.CodeApp.codeBrowserWithBranch(pull.fromProject.owner, pull.fromProject.name, "${commitId}", "${path}")",
            "sTplRawURLA"  : "@routes.CodeApp.showRawFile(pull.toProject.owner, pull.toProject.name, "${commitId}", "${path}")",
            "sTplRawURLB"  : "@routes.CodeApp.showRawFile(pull.fromProject.owner, pull.fromProject.name, "${commitId}", "${path}")"
        });
    });
</script>
}
